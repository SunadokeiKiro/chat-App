# プロジェクト概要
- サークル主催のイベントにて扱うwebアプリ「ROOMs」
- 画像表示、form送信・集計、チャットルームが存在する。
- 各ルームは、画面左側のタブを選択することにより利用できる。
- ルームは、管理者のみ閲覧可能、全員閲覧可能の二つの状態に変更可能。

## 基本
- ルーム選択、ルーム閲覧が可能。その他、ルームに準じた行動(チャットなど)が可能。
- 管理者は上記に加え、管理者のみ利用可能なルームや、管理者のみチャット可能なルームの利用、ルームの作成が可能。
- 管理者は事前に設定されたメールアドレス、パスワードで認証してログイン可能。
- ユーザーは表示名を自由に変更できます。

## UI/UXの特長
- **直感的な操作性**: Tailwind CSSによるモダンでレスポンシブなデザイン。
- **スムーズなアニメーション**: メッセージ表示や操作時に心地よいアニメーションを実装。
- **未読メッセージ通知**: スクロール中に新しいメッセージが届くと、未読件数をバッジで通知し、ワンクリックで最新のメッセージに移動可能。
- **返信元へのジャンプ**: 返信メッセージから元のメッセージへ簡単にジャンプできる機能。

### チャットルーム
- チャット欄では、参加者は匿名もしくは各自が設定したニックネームでコメントを送信できる。また、管理者が設定した共通の「バッジ」を選択して表示できる。
- 返事機能、いいね機能(無限に増やせる)、ハイパーリンク自動置き換え機能が存在する。
- 管理者のみコメント可能、全員コメント可能を切り替えられる。

### 画像表示ルーム
- 単一、もしくは複数の画像を表示する。
- 画像は外部リンクを埋め込むスタイル。

### Form送信・集計ルーム
- ルーム作成時、管理者はCSVファイルをアップロードすることでアンケートフォームを作成できる。
- CSVの形式：1列目に質問タイプ、2列目に対象ラベル(全員の場合はハイフン"-")、3列目に必須かどうか(R/NR)、4列目に質問文、5列目以降に選択肢を記述する。
- 質問タイプには、一行入力・複数行入力・単一選択・複数選択・星評価などが利用できる。
- ユーザーがフォームを送信すると、管理者のみが閲覧できる集計ルームにデータが蓄積される。

### 集計ルーム
- アンケートの結果をリアルタイムで集計・表示する。
- 全員の回答を一覧表示する「集計結果」タブと、単一選択式の質問を円グラフで、星評価の質問を平均点で表示する「グラフ」タブが存在する。

### 管理者機能
- 上記に加え、管理者は以下の機能を利用できる。
- ルームの作成・削除
- ルームの公開/非公開設定
- チャットルームのコメント許可/禁止設定
- 全ルーム共通のバッジ（ラベル）の追加・削除
- 全てのメッセージの削除

## 技術スタック
- **Frontend:** HTML, Tailwind CSS, JavaScript
- **Backend (BaaS):** Firebase
  - **Authentication:** 匿名認証およびメールアドレス/パスワード認証による管理者ログイン機能。
  - **Firestore:** ルーム情報、チャットメッセージ、アンケート回答などのデータをリアルタイムで管理。
- **Libraries:**
  - **Chart.js:** アンケートの集計結果を円グラフなどで視覚化。
  - **SheetJS (xlsx):** アンケート作成時のCSVファイル解析およびチャット履歴のExcelダウンロード。

## Firebaseのデータ構造
- このアプリケーションでは、主に以下の4つのコレクションを使用しています。

### 1. `rooms`
- 各ルームの情報を格納するコレクション。

| フィールド名 | 型 | 説明 |
| :--- | :--- | :--- |
| `name` | String | ルームの表示名 |
| `type` | String | ルームの種類 (`chat`, `image`, `survey`, `survey_result`) |
| `createdAt` | Timestamp | ルームの作成日時 |
| `createdBy` | String | 作成した管理者のUID |
| `isPublic` | Boolean | `true`の場合、ゲストも入室可能 |
| `canComment` | Boolean | `true`の場合、ゲストもコメント可能 (チャットルームのみ) |
| `imageUrl` | String | 表示する画像のURL (画像ルームのみ) |
| `questions` | Array | アンケートの質問リスト (アンケートルームのみ) |
| `sourceSurveyId` | String | 集計元のアンケートID (集計ルームのみ) |

### 2. `messages`
- チャットルームのメッセージデータを格納するコレクション。

| フィールド名 | 型 | 説明 |
| :--- | :--- | :--- |
| `text` | String | メッセージ本文 |
| `roomId` | String | 所属するルームのID |
| `uid` | String | 送信者のUID (管理者/ゲスト) |
| `clientId` | String | ゲストを識別するためのクライアントID |
| `senderName` | String | 送信者の表示名 |
| `senderLabel` | String | 送信者が選択したバッジ |
| `createdAt` | Timestamp | メッセージの送信日時 |
| `likes` | Number | いいねの数 |
| `isAdmin` | Boolean | `true`の場合、管理者によるメッセージ |
| `replyToId` | String | (返信時)返信先のメッセージID |
| `replyToText` | String | (返信時)返信先のメッセージ本文(一部) |
| `replyToName` | String | (返信時)返信先のユーザー名 |

### 3. `survey_responses`
- アンケートへの回答データを格納するコレクション。

| フィールド名 | 型 | 説明 |
| :--- | :--- | :--- |
| `roomId` | String | 回答したアンケートのルームID |
| `uid` | String | 回答者のUID |
| `clientId` | String | 回答者を識別するためのクライアントID |
| `senderName` | String | 回答者の表示名 |
| `responses` | Map | 質問IDをキー、回答内容を値とするマップ |
| `createdAt` | Timestamp | 回答の送信日時 |

### 4. `settings`
- アプリケーション全体の設定を格納するコレクション。

- **`badges` ドキュメント**:
  - `list` (Array): 管理者が設定した全ルーム共通で利用可能なバッジ名のリスト。


## CSVフォーマットの具体例
- アンケートフォームを作成する際のCSVファイルのサンプルです。（Ver8.3以降：対象ラベル列が追加されました）
- 1行目が1つの質問に対応します。

```csv
selection,-,R,イベントの満足度を教えてください,大変満足,満足,普通,不満,大変不満
star,学生,R,セッションの分かりやすさはいかがでしたか？
input_long,社会人,R,学生から刺激を受けましたか？
multi_selection,-,NR,興味のある分野を教えてください（複数選択可）,Web開発,データサイエンス,AI/機械学習,インフラ,その他
input,-,R,お名前（ニックネーム可）
```

## CSVフォーマットの具体例が生成するフォーム
- **1列目:** 質問タイプ
- **2列目:** 対象ラベル（`-` なら全員、`学生` ならそのバッジ選択者のみ表示）
- **3列目:** 必須 (`R`) / 任意 (`NR`)
- **4列目:** 質問文
- **5列目以降:** 選択肢

# issue
- formに一回入力した情報が保持されるようにしたい


# 完了したissue
-  リファクタリング(レイヤードアーキテクチャになぞらえ、UI、アプリケーション、ドメイン、インフラ層にコメントアウトで区切って記述。user-select noneでない部分は必要最低限とする。)

- スマートフォン向けの表示を整える。現状、formsの集計結果にて、PCでは問題ないが、スマートフォン上だと表の横幅が大きすぎて視認性が悪い。

- formに入力した情報が保持されない。送信するまでは保持したい。

- 画像表示ルームにて、複数の画像の表示にも対応されたい。

- formの集計結果のグラフタブにて、複数選択の質問は積み上げ縦棒グラフで表示したい。

- formの集計結果のグラフタブにて、星の評価に実際に星のイラストを表示したい。(3.6個なら3.6個分の★を表示する)

- ダウンロードボタンは、チャット履歴をダウンロードするものだが、現在はチャット履歴のCSVファイルをダウンロードするものになっている。フォーム収集結果タブでは、フォームの結果をcsvファイルとしてダウンロードできるようにしてほしい。

- ダウンロードボタンは、チャットタブとform収集結果タブ以外で表示しないようにする。

- 画像表示ルームにて、PCの場合画像の表示は基本中央にしたい。

- ルームのタブの入れ替えを自由にしたい。

- form集計結果ルームにて、表のCSVダウンロードボタンのいちを、集計結果、グラフタブの右に移行したい。(Ver 8.2.0)

- form集計結果ルームにて、集計結果の表にて、回答者欄に学生か社会人かなど、ラベル情報も追記したい。(Ver 8.2.0)

- form集計結果ルームにて、集計結果の表の横幅を、選択や複数選択の質問項目においてはもう少し横長にしたい(スマホ表示時)。今、横幅が1文字分など極端に少なくなってしまっている。選択肢の文字数分横幅を取るなどしてなんとかしたい。(Ver 8.2.0)

- アンケートのcsvのフォーマットを変更し、ラベル（学生・社会人など）に応じて異なる質問を表示できるようにしたい。(Ver 8.3.0)

- アンケートルームおよび集計ルームを開いた際、スクロール位置を自動的に最上部にリセットするように修正。(Ver 8.3.0)

- PC表示時に、横長のテーブル（集計結果）を表示した際、スクロールバーが正常に機能せず端まで見られない問題を修正。(Ver 8.3.0)